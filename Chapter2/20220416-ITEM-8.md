# [ì•„ì´í…œ 8] finalizerì™€ cleaner ì‚¬ìš©ì„ í”¼í•˜ë¼

ì‘ì„±ì: ê¹€ëŒ€í¬

ì‘ì„±ì¼: 2022ë…„ 4ì›” 16ì¼

---

## ìë°”ê°€ ì œê³µí•˜ëŠ” ë‘ ê°€ì§€ ê°ì²´ ì†Œë©¸ì

### finalizer

- ì˜ˆì¸¡í•  ìˆ˜ ì—†ê³  ìƒí™©ì— ë”°ë¼ ìœ„í—˜í•  ìˆ˜ ìˆì–´ ì¼ë°˜ì ìœ¼ë¡œ ë¶ˆí•„ìš”í•˜ë‹¤.
- ì˜¤ë™ì‘, ë‚®ì€ ì„±ëŠ¥, ì´ì‹ì„± ë¬¸ì œì˜ ì›ì¸ì´ ë˜ê¸°ë„ í•œë‹¤.
- ë”°ë¼ì„œ ê¸°ë³¸ì ìœ¼ë¡œ ì“°ì§€ ë§ì•„ì•¼í•œë‹¤.

### cleaner

- finalizerì˜ ëŒ€ì•ˆìœ¼ë¡œ ì†Œê°œë˜ì§€ë§Œ, ì—¬ì „íˆ ì˜ˆì¸¡í•  ìˆ˜ ì—†ê³ , ëŠë¦¬ê³ , ì¼ë°˜ì ìœ¼ë¡œ ë¶ˆí•„ìš”í•˜ë‹¤.

> C++ í”„ë¡œê·¸ë˜ë¨¸ë¼ë©´ ì£¼ì˜í•´ì•¼í•  ë‚´ìš©
> 
> 
> finalizerì™€ cleanerëŠ” C++ì˜ destructorì™€ ë‹¤ë¥¸ ê°œë…ì´ë©°, destructorëŠ” constructorì˜ ëŒ€ì²™ì ì´ë‹¤.
> 
> í•˜ì§€ë§Œ, ìë°”ëŠ” ì ‘ê·¼í•  ìˆ˜ ì—†ëŠ” ê°ì²´ë¥¼ íšŒìˆ˜í•˜ëŠ” ì—­í• ì€ ê°€ë¹„ì§€ ì»¬ë ‰í„°ê°€ ë‹´ë‹¹í•œë‹¤.
> 

## finalizerì™€ cleaner ì‚¬ìš©ì„ ì§€ì–‘í•´ì•¼í•˜ëŠ” ì´ìœ 

- ì¦‰ì‹œ ìˆ˜í–‰ëœë‹¤ëŠ” ë³´ì¥ì´ ì—†ë‹¤. ì¦‰, finalizerì™€ cleanerë¡œëŠ” ì œë•Œ ì‹¤í–‰ë˜ì–´ì•¼ í•˜ëŠ” ì‘ì—…ì€ ì ˆëŒ€ í•  ìˆ˜ ì—†ë‹¤. â†’ íŒŒì¼ ë‹«ê¸° ê°™ì€ ì‘ì—…ì„ ë§¡ê¸°ë©´ ì¤‘ëŒ€í•œ ì˜¤ë¥˜ë¥¼ ì¼ìœ¼í‚¬ ìˆ˜ ìˆë‹¤.
- ìˆ˜í–‰ ì‹œì  ë¿ë§Œì´ ì•„ë‹ˆë¼ ìˆ˜í–‰ ì—¬ë¶€ ì¡°ì°¨ ë³´ì¥í•˜ì§€ ì•ŠëŠ”ë‹¤. â†’ ê¼­ ë°˜ë‚©í•´ì•¼í•˜ëŠ” ìì›ì„ ë°˜ë‚©í•˜ì§€ ëª»í•œ ì±„ í”„ë¡œê·¸ë¨ì´ ì¤‘ë‹¨ë  ìˆ˜ë„ ìˆë‹¤.

<aside>
ğŸ’¡ ìƒíƒœë¥¼ ì˜êµ¬ì ìœ¼ë¡œ ìˆ˜ì •í•˜ëŠ” ì‘ì—…ì—ì„œ ì ˆëŒ€ finalizerë‚˜ cleanerì— ì˜ì¡´í•´ì„œëŠ” ì•ˆëœë‹¤.

</aside>

- finalizer ë™ì‘ ì¤‘ ë°œìƒí•œ ì˜ˆì™¸ëŠ” ë¬´ì‹œë˜ë©°, ì²˜ë¦¬í•  ì‘ì—…ì´ ë‚¨ì•˜ë”ë¼ë„ ê·¸ ìˆœê°„ ì¢…ë£Œëœë‹¤.
- ë˜í•œ, ì‹¬ê°í•œ ì„±ëŠ¥ ë¬¸ì œ ë˜í•œ ë™ë°˜í•œë‹¤. try-with-resources ì™€ ë¹„êµí•˜ì—¬ ì•½ 50ë°°ë‚˜ ëŠë¦´ ìˆ˜ ìˆë‹¤.
- finalizer ê³µê²©ì— ë…¸ì¶œë˜ì–´ ì‹¬ê°í•œ ë³´ì•ˆ ë¬¸ì œë¥¼ ì¼ìœ¼í‚¬ ìˆ˜ë„ ìˆë‹¤.
    - finalì´ ì•„ë‹Œ í´ë˜ìŠ¤ë¥¼ finalizer ê³µê²©ìœ¼ë¡œë¶€í„° ë°©ì–´í•˜ë ¤ë©´ ì•„ë¬´ ì¼ë„ í•˜ì§€ ì•ŠëŠ” finalize ë©”ì„œë“œë¥¼ ë§Œë“¤ê³  finalë¡œ ì„ ì–¸í•˜ì.

## finalizerë‚˜ cleanerë¥¼ ëŒ€ì‹ í•´ ì‚¬ìš©í•´ì•¼í•  ë°©ë²•

- AutoCloseable ì„ êµ¬í˜„í•´ì£¼ê³ . í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë‹¤ ì“°ê³  ë‚œë‹¤ë©´ close ë©”ì„œë“œë¥¼ í˜¸ì¶œí•œë‹¤. (ì˜ˆì™¸ê°€ ë°œìƒí•´ë„ ì œëŒ€ë¡œ ì¢…ë£Œë˜ë„ë¡ try-with-resourcesë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤)
- ê° ì¸ìŠ¤í„´ìŠ¤ëŠ” ìì‹ ì´ ë‹«í˜”ëŠ”ì§€ë¥¼ ì¶”ì í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤. â†’ close ë©”ì„œë“œì—ì„œ ì´ ê°ì²´ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŒì„ í•„ë“œì— ê¸°ë¡í•˜ê³ , ë‹¤ë¥¸ ë©”ì„œë“œëŠ” ì´ í•„ë“œë¥¼ ê²€ì‚¬í•´ì„œ ë‹«íŒ í›„ì— ë¶ˆë ¸ë‹¤ë©´ IllegalStateExceptionì„ ë˜ì§€ë„ë¡ í•¨.

## ê·¸ëŸ¼ì—ë„, finalizerì™€ cleanerë¥¼ ì‚¬ìš©í•˜ëŠ” ìš©ë„

- ìì›ì˜ ì†Œìœ ìê°€ close ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ì§€ ì•ŠëŠ” ê²ƒì— ëŒ€ë¹„í•œ ì•ˆì „ë§ ì—­í• ë¡œ, í´ë¼ì´ì–¸íŠ¸ê°€ í•˜ì§€ ì•Šì€ ìì› íšŒìˆ˜ë¥¼ ëŠ¦ê²Œë¼ë„ í•´ì£¼ëŠ” ê²ƒì´ ë‚«ë‹¤ëŠ” ì˜ë¯¸.
- ë„¤ì´í‹°ë¸Œ í”¼ì–´(native peer)ì™€ ì—°ê²°ëœ ê°ì²´
    
    > ë„¤ì´í‹°ë¸Œ ê°ì²´ë€?
    - ë„¤ì´í‹°ë¸Œ í”¼ì–´ë€ ì¼ë°˜ ìë°” ê°ì²´ê°€ ë„¤ì´í‹°ë¸Œ ë©”ì„œë“œë¥¼ í†µí•´ ê¸°ëŠ¥ì„ ìœ„ì„í•œ ë„¤ì´í‹°ë¸Œ ê°ì²´
    - Java ì™¸ì˜ í”„ë¡œê·¸ë˜ë° ì–¸ì–´(C/C++ ì´ë‚˜ ì–´ì…ˆë¸”ë¦¬)ë¡œ ì»´íŒŒì¼í•œ í”„ë¡œê·¸ë¨ì„ ì§€ì¹­í•˜ë©°, ì´ë¥¼ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œì¨ ìë°” í”¼ì–´ê°€ ì‹¤í–‰í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ì¸í„°í˜ì´ìŠ¤ë¥¼ JNI (Java Native Interface)ë¼ê³  í•œë‹¤.
    > 
    
    [https://github.com/java-squid/effective-java/issues/8](https://github.com/java-squid/effective-java/issues/8)
    
    - ìë°” ê°ì²´ê°€ ì•„ë‹ˆë‹ˆ ê°€ë¹„ì§€ ì»¬ë ‰í„°ëŠ” ê·¸ ì¡´ì¬ë¥¼ ì•Œì§€ ëª»í•œë‹¤. ê·¸ ê²°ê³¼ ê°€ë¹„ì§€ ì»¬ë ‰í„°ê°€ ë„¤ì´í‹°ë¸Œ ê°ì²´ëŠ” íšŒìˆ˜í•˜ì§€ ëª»í•œë‹¤.
    - ì´ëŸ° ê²½ìš° cleanerë‚˜ finalizerë¥¼ ì‚¬ìš©í•˜ë©°, ì„±ëŠ¥ ì €í•˜ë¥¼ ê°ë‹¹í•  ìˆ˜ ìˆê³ , ì‹¬ê°í•œ ìì›ì„ ê°€ì§€ê³  ìˆì§€ ì•Šì„ ê²½ìš° í•´ë‹¹ëœë‹¤. â†’ ì¦‰ì‹œ íšŒìˆ˜í•´ì•¼ í•œë‹¤ë©´ close ë©”ì„œë“œë¥¼ ì‚¬ìš©í•´ì•¼í•œë‹¤.

### cleanerë¥¼ ì•ˆì „ë§ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” AutoCloseable í´ë˜ìŠ¤

```java
class Room implements AutoCloseable {
    private static final Cleaner cleaner = Cleaner.create();
	
    // ì²­ì†Œê°€ í•„ìš”í•œ ìì›ìœ¼ë¡œ Roomì„ ì°¸ì¡°í•˜ê²Œë˜ë©´ ìˆœí•œ ì°¸ì¡°ê°€ ì¼ì–´ë‚˜ê¸°ì— íšŒìˆ˜í•˜ì§€ ëª»í•œë‹¤.
    // ë”°ë¼ì„œ ì ˆëŒ€ Roomì„ ì°¸ì¡°í•˜ì§€ ë§ ê²ƒ!
    private static class State implements Runnable {
        int numJunkPile;
	
        public State(int numJunkPile) {
            this.numJunkPile = numJunkPile;
        }
	
        @Override
        public void run() {
            System.out.println("ë°© ì²­ì†Œ");
            numJunkPile = 0;
        }
    }
	
    private final State state;
	
    private final Cleaner.Cleanable cleanable;
	
    public Room(int numJunkPile) {
        this.state = new State(numJunkPile);
        cleanable = cleaner.register(this, state);
    }
	
    @Override
    public void close() throws Exception {
        cleanable.clean();
    }
}
```

- State ì¸ìŠ¤í„´ìŠ¤ëŠ” ì ˆëŒ€ë¡œ Room ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì°¸ì¡°í•´ì„œëŠ” ì•ˆëœë‹¤ â†’ ìˆœí™˜ ì°¸ì¡° ë°œìƒìœ¼ë¡œ ê°€ë¹„ì§€ ì»¬ë ‰í„°ê°€ íšŒìˆ˜ í•  ìˆ˜ ì—†ê²Œ ë¨.
- ì´ëŠ” Stateê°€ ì •ì  ì¤‘ì²© í´ë˜ìŠ¤ì¸ ì´ìœ ë¡œ, ì •ì ì´ ì•„ë‹Œ í´ë˜ìŠ¤ëŠ” ìë™ìœ¼ë¡œ ë°”ê¹¥ ê°ì²´ì˜ ì°¸ì¡°ë¥¼ ê°–ê²Œëœë‹¤.
- ë¹„ìŠ·í•˜ê²Œ ëŒë‹¤ ì—­ì‹œ ë°”ê¹¥ ê°ì²´ì˜ ì°¸ì¡°ë¥¼ ê°–ê¸° ì‰¬ìš°ë‹ˆ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ê²ƒì´ ì¢‹ë‹¤.

## Cleanerì˜ ë™ì‘

cleanerëŠ” Java 9 ì—ì„œ finalizerì˜ ëŒ€ì•ˆìœ¼ë¡œ ë„ì…ë˜ì—ˆìœ¼ë©°, cleanerê°ì²´ì— ëª¨ë‹ˆí„°ë§í•  objectì™€, ê°ì²´ê°€ ì†Œë©¸í•  ë•Œ ìì›ì„ íšŒìˆ˜í•˜ëŠ” actionì„ ë“±ë¡í•˜ê³ , clean() ë©”ì„œë“œê°€ ìˆ˜í–‰ë˜ë©´ actionì„ ì‹¤í–‰í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë™ì‘í•œë‹¤.

![Untitled](%5B%E1%84%8B%E1%85%A1%E1%84%8B%E1%85%B5%E1%84%90%E1%85%A6%E1%86%B7%208%20da195/Untitled.png)

[Cleaner (Java SE 9 & JDK 9 )](https://docs.oracle.com/javase/9/docs/api/java/lang/ref/Cleaner.html)